<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.siruiman.crosslogistics.mapper.BagMapper">
    <resultMap id="BaseResultMap" type="com.siruiman.crosslogistics.model.Bag">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="bag_id" jdbcType="INTEGER" property="bagId"/>
        <result column="length" jdbcType="DOUBLE" property="length"/>
        <result column="width" jdbcType="DOUBLE" property="width"/>
        <result column="high" jdbcType="DOUBLE" property="high"/>
        <result column="load" jdbcType="DOUBLE" property="load"/>
        <result column="bag_number" jdbcType="VARCHAR" property="bagNumber"/>
        <result column="state" jdbcType="SMALLINT" property="state"/>
        <result column="warehouse_id" jdbcType="INTEGER" property="warehouseId"/>
        <result column="rally_point_id" jdbcType="INTEGER" property="rallyPointId"/>
        <result column="warehouse_positions_id" jdbcType="INTEGER" property="warehousePositionsId"/>
        <result column="admin_uid" jdbcType="INTEGER" property="adminUid"/>
        <result column="car_id" jdbcType="INTEGER" property="carId"/>
        <result column="truck_id" jdbcType="INTEGER" property="truckId"/>
        <result column="singapore_area_name" property="singaporeAreaName" jdbcType="VARCHAR"/>
        <result column="rally_point_name" property="rallyPointName" jdbcType="VARCHAR"/>
        <result column="init_warehouse_id" property="initWarehouseId" jdbcType="INTEGER"/>
        <result column="init_wp_id" property="initWpId" jdbcType="INTEGER"/>
        <result column="last_warehouse_id" property="lastWarehouseId" jdbcType="INTEGER"/>
        <result column="last_wp_id" property="lastWpId" jdbcType="INTEGER"/>
        <result column="car_number" property="carNumber" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="init_wp_number" property="initWpNumber" jdbcType="VARCHAR"/>
        <result column="last_wp_number" property="lastWpNumber" jdbcType="VARCHAR"/>
        <result column="init_warehouse_name" property="initWarehouseName" jdbcType="VARCHAR"/>
        <result column="last_warehouse_name" property="lastWarehouseName" jdbcType="VARCHAR"/>
        <result column="del_state" property="delState" jdbcType="SMALLINT"/>
        <result column="staff_name" property="staffName" jdbcType="VARCHAR"/>
        <association property="info" column="bag_id"
                     select="com.siruiman.crosslogistics.mapper.LogisticInfoMapper.selectLogisticInfoByBagId"/>
    </resultMap>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from bag
        where bag_id = #{bagId,jdbcType=INTEGER}
    </delete>
    <insert id="insert" parameterType="com.siruiman.crosslogistics.model.Bag">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into bag (bag_id, `length`, width,
        high, `load`, bag_number,singapore_area_id,rally_point_id,create_time,staff_id,warehouse_id)
        values (#{bagId,jdbcType=INTEGER}, #{length,jdbcType=DOUBLE}, #{width,jdbcType=DOUBLE},
        #{high,jdbcType=DOUBLE}, #{load,jdbcType=DOUBLE}, #{bagNumber,jdbcType=VARCHAR},
        #{singaporeAreaId,jdbcType=INTEGER},#{rallyPointId,jdbcType=INTEGER},#{createTime,jdbcType=TIMESTAMP},
        #{staffId,jdbcType=INTEGER},#{warehouseId})
    </insert>
    <update id="updateByPrimaryKey" parameterType="com.siruiman.crosslogistics.model.Bag">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update bag
        set `length` = #{length,jdbcType=REAL},
        width = #{width,jdbcType=REAL},
        high = #{high,jdbcType=REAL},
        `load` = #{load,jdbcType=REAL},
        bag_number = #{bagNumber,jdbcType=VARCHAR},
        `state` = #{state,jdbcType=SMALLINT},
        rally_point_id = #{rallyPointId,jdbcType=INTEGER},
        admin_uid = #{adminUid,jdbcType=INTEGER},
        car_id = #{carId,jdbcType=INTEGER},
        truck_id = #{truckId,jdbcType=INTEGER},
        update_time = #{updateTime,jdbcType=TIMESTAMP},
        del_state = #{delState,jdbcType=SMALLINT}
        where bag_id = #{bagId,jdbcType=INTEGER}
    </update>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select bag_id, `length`, width, high, `load`, bag_number, `state`, warehouse_id,
        rally_point_id, warehouse_positions_id, admin_uid, car_id, truck_id
        from bag
        where bag_id = #{bagId,jdbcType=INTEGER}
    </select>
    <select id="selectAll" resultMap="BaseResultMap" parameterType="com.siruiman.crosslogistics.model.Bag">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select distinct bag.bag_id,truck.license_plate as licensePlate,car.car_number as carNumber,
        sg.singapore_area_name as sgName,bag.`state`
        from bag
        left join task_order_bag tob on tob.bag_id = bag.bag_id

        left join car on bag.car_id =car.car_id
        left join singapore_area sg on sg.singapore_area_id = bag.singapore_area_id
        where bag.del_state = 1
        <if test="bagNumber !=null and bagNumber !=''">
            and bag.bag_number =#{bagNumber,jdbcType=VARCHAR}
        </if>
        <if test="state !=null and state !=''">
            and bag.`state` =#{state,jdbcType=SMALLINT}
        </if>
    </select>
    <select id="selectCountBag" resultType="java.lang.Integer" parameterType="com.siruiman.crosslogistics.model.Bag">
        select count(b.bag_id) from
        (select distinct bag.bag_id,truck.license_plate as licensePlate,car.car_number as carNumber,
        sg.singapore_area_name as sgName,bag.`state`
        from bag
        left join task_order_bag tob on tob.bag_id = bag.bag_id
        left join truck on bag.truck_id = truck.truck_id
        left join car on bag.car_id = car.car_id
        left join singapore_area sg on sg.singapore_area_id = bag.singapore_area_id
        where bag.del_state = 1
        <if test="bagNumber !=null and bagNumber !=''">
            and bag.bag_number =#{bagNumber,jdbcType=VARCHAR}
        </if>
        <if test="state !=null and state !=''">
            and bag.`state` =#{state,jdbcType=SMALLINT}
        </if>
        ) as b
    </select>

    <!--根据货袋id查询货袋所关联的仓库仓位 及任务订单编号及状态
            张占伟
    -->
    <select id="selectBagDetailedOfWarehouseById" resultType="com.siruiman.crosslogistics.model.Bag"
            parameterType="int">
      select distinct tod.order_number as orderNumber,bag.bag_id, warehouse.warehouse_name as warehouseName ,wp.wp_number as wpNumber,bag.`state`
      from  bag
      left join task_order_bag tob on tob.bag_id = bag.bag_id
      left join task_order tod on tob.task_order_id = tod.task_order_id
      left join warehouse on warehouse.warehouse_id = bag.warehouse_id
      left join warehouse_positions as wp on wp.wp_id = bag.warehouse_positions_id
      left join singapore_area as sg on sg.singapore_area_id = bag.singapore_area_id
      where bag.bag_id = #{bagId,jdbcType=INTEGER}
  </select>
    <!--根据货袋id查询货袋状态
                  张占伟
    -->
    <select id="selectBagStateById" resultType="com.siruiman.crosslogistics.model.Bag" parameterType="int">
            select bag_id,bag.`state` from bag
            where bag_id = #{bagId,jdbcType=INTEGER}
  </select>
    <select id="selectBagListByTruckId" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
            WARNING  -  @mbggenerated
            This  element  is  automatically  generated  by  MyBatis  Generator,  do  not  modify.
        -->
        select bag.bag_id, bag.`length`, bag.width, bag.high, bag.`load`, bag.bag_number, bag.`state`,
        sa.singapore_area_name,wp2.wp_number AS last_wp_number,wh2.warehouse_name AS
        last_warehouse_name,rp.rally_point_name
        from bag
        LEFT JOIN singapore_area AS sa ON (bag.singapore_area_id = sa.singapore_area_id)
        LEFT JOIN rally_point AS rp ON (bag.rally_point_id = rp.rally_point_id)
        LEFT JOIN warehouse AS wh2 ON (bag.last_warehouse_id = wh2.warehouse_id)
        LEFT JOIN warehouse_positions AS wp2 ON (bag.last_wp_id=wp2.wp_id)
        WHERE bag.truck_id = #{truckId} AND bag.`state` = 6
    </select>
    <select id="selectCountBagListByTruckId" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        <!--
            WARNING  -  @mbggenerated
            This  element  is  automatically  generated  by  MyBatis  Generator,  do  not  modify.
        -->
        select COUNT(bag.bag_id)
        from bag
        LEFT JOIN singapore_area AS sa ON (bag.singapore_area_id = sa.singapore_area_id)
        LEFT JOIN rally_point AS rp ON (bag.rally_point_id = rp.rally_point_id)
        LEFT JOIN warehouse AS wh2 ON (bag.last_warehouse_id = wh2.warehouse_id)
        LEFT JOIN warehouse_positions AS wp2 ON (bag.last_wp_id=wp2.wp_id)
        WHERE bag.truck_id = #{truckId} AND bag.`state` = 6
    </select>
    <select id="selectByBagNumber" parameterType="string" resultType="java.lang.Integer">
    select bag_id from bag where bag_number = #{bagNumber,jdbcType=VARCHAR}
  </select>

    <update id="updateBagState" parameterType="com.siruiman.crosslogistics.model.Bag">
        update bag
        set `state` =#{bag.state,jdbcType=INTEGER},
        update_time =#{bag.updateTime,jdbcType=TIMESTAMP}
        where
        <if test="bag.bagId != 0 and bag.bagId != ''">
            bag_id =#{bag.bagId,jdbcType=INTEGER}
        </if>
    </update>
    <select id="selectBagIdByBagNumber" parameterType="string" resultType="java.lang.Integer">
    select bag_id from bag
    where bag_number = #{bagNumber,jdbcType = VARCHAR}
  </select>
    <!--
        根据货袋编号查出货袋包括基本数据资料、所属仓库、仓位、货架信息、配送地点位置信息、状态信息、货袋内货物列表清单，节点操作人员记录等

    -->
    <select id="selectBagDetailedByBagNumber" parameterType="string" resultType="com.siruiman.crosslogistics.model.Bag">
      SELECT
          bag.bag_id,
          bag.bag_number,
          sg.singapore_area_name,
          rp.rally_point_name,
          bag.singapore_area_id,
          bag.rally_point_id,
          bag.staff_id,
          bag.`state`,
          bag.length,
          bag.width,
          bag.high,
          bag.`load`,
          bag.create_time,
          bag.update_time,
          st.staff_name,
          bag.last_warehouse_id,
          bag.last_wp_id,
          wh2.warehouse_name AS last_warehouse_name,
          wp2.wp_number AS last_wp_number
          FROM bag
          LEFT JOIN singapore_area AS sg ON sg.singapore_area_id = bag.singapore_area_id
          LEFT JOIN rally_point AS rp ON rp.rally_point_id = bag.rally_point_id
          LEFT JOIN staff AS st ON st.staff_id = bag.staff_id
          LEFT JOIN warehouse AS wh2 ON bag.last_warehouse_id = wh2.warehouse_id
          LEFT JOIN warehouse_positions AS wp2 ON (bag.last_wp_id = wp2.wp_id)
          WHERE bag.bag_number =#{bagNumber}
  </select>
    <!--todo 货袋更新  无意义待定-->
    <update id="updateBag" parameterType="com.siruiman.crosslogistics.model.Bag">
    update bag
    set bag
</update>

    <select id="selectBagById" resultType="com.siruiman.crosslogistics.model.Bag">
SELECT bag.bag_id,bag.bag_number,bag.state,car.car_number,sa.singapore_area_name,wp1.wp_number AS init_wp_number,wp2.wp_number AS last_wp_number,wh1.warehouse_name AS init_warehouse_name,wh2.warehouse_name AS last_warehouse_name
FROM bag
LEFT JOIN car ON (bag.car_id = car.car_id)
LEFT JOIN singapore_area AS sa ON (bag.singapore_area_id = sa.singapore_area_id)
LEFT JOIN warehouse AS wh1 ON (bag.init_warehouse_id = wh1.warehouse_id)
LEFT JOIN warehouse AS wh2 ON (bag.last_warehouse_id = wh2.warehouse_id)
LEFT JOIN warehouse_positions AS wp1 ON (bag.init_wp_id=wp1.wp_id)
LEFT JOIN warehouse_positions AS wp2 ON (bag.last_wp_id=wp2.wp_id)
WHERE bag_id = #{bagId}
  </select>


    <update id="updateBagInitWarehouse">
        update bag set
        init_warehouse_id =#{warehouseId},
        <if test="wpId!=0">
            init_wp_id=#{wpId},
        </if>
        update_time=#{updateTime,jdbcType=TIMESTAMP}
        where bag_id =#{bagId}
    </update>
    <update id="updateBagLastWarehouse">
    update bag set
    last_warehouse_id =#{warehouseId},
    last_wp_id=#{wpId},
    `state` = 3,
    update_time=#{updateTime,jdbcType=TIMESTAMP}
    where bag_id =#{bagId}
  </update>
    <select id="selectBagByNumber" parameterType="string" resultType="com.siruiman.crosslogistics.model.Bag">
    select sa.singapore_area_name,rp.rally_point_name,bag.bag_id ,bag.bag_number,bag.create_time
    from bag
    left join singapore_area as  sa on bag.singapore_area_id = sa.singapore_area_id
    left join rally_point as rp on bag.rally_point_id = rp.rally_point_id
    where bag.bag_number = #{bagNumber,jdbcType = VARCHAR}
  </select>


    <update id="updateBagInTruck" parameterType="com.siruiman.crosslogistics.model.Bag">
    update bag set
    update_time=#{bag.updateTime,jdbcType=TIMESTAMP},
    truck_id =#{bag.truckId},
    `state` = 4
    where
    bag_id =#{bag.bagId}
  </update>

    <select id="selectBagPrint" resultType="com.siruiman.crosslogistics.model.Bag">
    select sa.singapore_area_name,rp.rally_point_name,bag.bag_id ,bag.bag_number,bag.create_time,bag.warehouse_id
    from bag
    left join singapore_area as  sa on bag.singapore_area_id = sa.singapore_area_id
    left join rally_point as rp on bag.rally_point_id = rp.rally_point_id
    where bag.print_state = 1 limit 1
  </select>

    <update id="updateBagPrintState">
  update bag set
      print_state = #{printState}
  where bag_id =#{bagId}
</update>


    <select id="selectTruckIdByBagId" parameterType="int" resultType="java.lang.Integer">
    select truck_id from bag
    where bag_id =#{bagId}
  </select>

    <select id="selectBagId" resultMap="BaseResultMap">
    select bag_id,bag_number,state,car_id from bag
    where car_id =#{carId} and state = #{state}
    ORDER BY bag_id DESC LIMIT 1
  </select>

    <select id="selectBagList" resultMap="BaseResultMap" parameterType="map">
        SELECT
        bag.bag_id,bag.bag_number,bag.state,bag.create_time,sa.singapore_area_name,rp.rally_point_number,rp.rally_point_name,car.car_number,truck.license_plate,truck.`name`,wh.warehouse_name
        AS last_warehouse_name,
        wp.wp_number as last_wp_number,bag.rally_point_id,bag.singapore_area_id,bag.car_id
        FROM bag
        LEFT JOIN rally_point AS rp ON (bag.rally_point_id = rp.rally_point_id)
        LEFT JOIN singapore_area AS sa ON (bag.singapore_area_id = sa.singapore_area_id)
        LEFT JOIN car ON (bag.car_id = car.car_id)
        LEFT JOIN truck ON (bag.truck_id = truck.truck_id)
        LEFT JOIN warehouse AS wh ON (bag.last_warehouse_id =wh.warehouse_id)
        LEFT JOIN warehouse_positions AS wp ON (bag.last_wp_id = wp.wp_id)
        <where>
            bag.del_state = 1
            <if test="bagNumber != null and bagNumber != ''">
                AND bag.bag_number like "%"#{bagNumber}"%"
            </if>
            <if test="carNumber != null and carNumber != ''">
                AND car.car_number like "%"#{carNumber}"%"
            </if>
            <if test="state != null and state != ''">
                AND bag.state = #{state}
            </if>
            <if test="singaporeAreaId != null and singaporeAreaId != ''">
                AND bag.singapore_area_id = #{singaporeAreaId}
            </if>
            <if test="rallyPointId != null and rallyPointId != ''">
                AND bag.rally_point_id = #{rallyPointId}
            </if>
            <if test="licensePlate != null and licensePlate != ''">
                AND truck.license_plate like "%"#{licensePlate}"%"
            </if>
            <if test="warehouseId != null and warehouseId != ''">
                AND bag.warehouse_id = #{warehouseId}
            </if>
        </where>
        ORDER BY bag.bag_id DESC
    </select>

    <select id="selectCountBagList" resultType="java.lang.Integer" parameterType="map">
        SELECT COUNT(bag.bag_id) AS count
        FROM bag
        LEFT JOIN rally_point AS rp ON (bag.rally_point_id = rp.rally_point_id)
        LEFT JOIN singapore_area AS sa ON (bag.singapore_area_id = sa.singapore_area_id)
        LEFT JOIN car ON (bag.car_id = car.car_id)
        LEFT JOIN truck ON (bag.truck_id = truck.truck_id)
        LEFT JOIN warehouse AS wh ON (bag.last_warehouse_id =wh.warehouse_id)
        LEFT JOIN warehouse_positions AS wp ON (bag.last_wp_id = wp.wp_id)
        <where>
            bag.del_state = 1
            <if test="bagNumber != null and bagNumber != ''">
                AND bag.bag_number like "%"#{bagNumber}"%"
            </if>
            <if test="carNumber != null and carNumber != ''">
                AND car.car_number like "%"#{carNumber}"%"
            </if>
            <if test="state != null and state != ''">
                AND bag.state = #{state}
            </if>
            <if test="singaporeAreaId != null and singaporeAreaId != ''">
                AND bag.singapore_area_id = #{singaporeAreaId}
            </if>
            <if test="rallyPointId != null and rallyPointId != ''">
                AND bag.rally_point_id = #{rallyPointId}
            </if>
            <if test="licensePlate != null and licensePlate != ''">
                AND truck.license_plate like "%"#{licensePlate}"%"
            </if>
            <if test="warehouseId != null and warehouseId != ''">
                AND bag.warehouse_id = #{warehouseId}
            </if>
        </where>
        ORDER BY bag.bag_id DESC
    </select>
    <select id="selectBagDetailsById" resultMap="BaseResultMap" parameterType="map">
    SELECT bag.bag_id,bag.bag_number,bag.state,bag.create_time,sa.singapore_area_name,rp.rally_point_number,rp.rally_point_name,car.car_number,truck.license_plate,truck.`name`,wh.warehouse_name AS last_warehouse_name,
    wp.wp_number as last_wp_number,bag.rally_point_id,bag.singapore_area_id,bag.del_state,bag.car_id
    FROM bag
    LEFT JOIN rally_point AS rp ON (bag.rally_point_id = rp.rally_point_id)
    LEFT JOIN singapore_area AS sa ON (bag.singapore_area_id = sa.singapore_area_id)
    LEFT JOIN car ON (bag.car_id = car.car_id)
    LEFT JOIN truck ON (bag.truck_id = truck.truck_id)
    LEFT JOIN warehouse AS wh ON (bag.last_warehouse_id =wh.warehouse_id)
    LEFT JOIN warehouse_positions AS wp ON (bag.last_wp_id = wp.wp_id)
    where  bag.bag_id = #{bagId}
  </select>

    <select id="selectSGWarehouseById" parameterType="int" resultType="int">
    SELECT last_wp_id FROM bag
    where bag_id = #{bagId}
  </select>

    <select id="selectByRallyPointId" resultMap="BaseResultMap" parameterType="int">
    SELECT  bag_id,bag_number,sa.singapore_area_id ,
    sa.singapore_area_name,rp.rally_point_name,rp.rally_point_id
    FROM bag
    LEFT JOIN singapore_area AS sa ON sa.singapore_area_id = bag.singapore_area_id
    LEFT JOIN rally_point AS rp ON rp.rally_point_id = bag.rally_point_id
     AND sa.singapore_area_id = rp.singapore_area_id
    WHERE bag.rally_point_id =#{rallyPointId}
    AND `state` = 3
  </select>

    <select id="selectBagByCarId" resultType="com.siruiman.crosslogistics.model.Bag" parameterType="java.lang.Integer">
   select bag_id,bag_number,state from bag
   where car_id = #{carId,jdbcType=INTEGER} AND state = 7
  </select>

    <select id="selectBagBySingaporeAreaId" resultMap="BaseResultMap" parameterType="java.lang.Integer">
    select bag_id,state,singapore_area_id FROM bag WHERE singapore_area_id = #{singaporeAreaId} AND state = 3
  </select>

    <update id="updateBagDirect">
    update bag set
    update_time = #{bag.updateTime,jdbcType=TIMESTAMP},
    truck_driver_id = #{bag.truckDriverId},
    `state` = 10
    where
    bag_id =#{bag.bagId}
  </update>

    <select id="selectBagByCarIdAndState" resultMap="BaseResultMap">
    SELECT bag.bag_id,bag.bag_number,bag.state,bag.create_time,bag.car_id
    FROM bag
    where  bag.car_id = #{carId} AND bag.state = #{state}
    ORDER BY bag.bag_id DESC LIMIT 1
  </select>

    <select id="selectBagListByTruckIdANDState" resultMap="BaseResultMap">
        <!--
            WARNING  -  @mbggenerated
            This  element  is  automatically  generated  by  MyBatis  Generator,  do  not  modify.
        -->
        select bag.bag_id, bag.`length`, bag.width, bag.high, bag.`load`, bag.bag_number, bag.`state`
        from bag
        WHERE bag.truck_id = #{truckId} AND bag.`state` = #{state}
    </select>


</mapper>